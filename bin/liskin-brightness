#!/usr/bin/env bash

# Adjust brightness of an external monitor using ddcutil
# Usage: liskin-brightness [ddcutil display number]

set -eu -o pipefail
shopt -s nullglob lastpipe

display="${1:-1}"

if [[ ${2-} ]]; then
	exec ddcutil --display "$display" setvcp 10 "${2}"
fi

ddcutil --display "$display" --terse getvcp 10 \
| while read -r f1 f2 _ val _; do
	if [[ $f1 == VCP && $f2 == 10 ]]; then
		current=$val
	fi
done
: "${current:?}"

trap 'pkill -P $$' EXIT

zenity --title "display $display brightness" --text "display $display brightness" --scale --print-partial --value="$current" \
| while read -r desired; do
	while read -r -t 0.2 desired_tmp; do desired="$desired_tmp"; done
	ddcutil --display "$display" setvcp 10 "$desired"
done
