#!/usr/bin/env bash

set -eu
export LC_ALL=C

# make sure there are no overrides for GIT_DIR etc.
if compgen -v | grep ^GIT_; then
	exit 1
fi

cd ~/backup/local/apt

[[ "$(git symbolic-ref HEAD)" == refs/heads/@(master|main) ]]  # quit if doing manual maintenance

apt-mark showhold > apt-mark-showhold.txt
apt-mark showauto > apt-mark-showauto.txt
apt-mark showmanual > apt-mark-showmanual.txt
dpkg-query --show --showformat='${binary:Package}\t${Version}\t${db:Status-Abbrev}\n' > dpkg-query-show.txt

# commit
git add .
git diff --cached --exit-code --quiet && diff=$? || diff=$?
[[ $diff != 1 ]] && exit "$diff"
git commit -m "$(date --iso-8601=seconds)"

# garbage collect
git gc-auto-exact 50
