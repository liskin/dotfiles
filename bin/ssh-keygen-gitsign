#!/usr/bin/env bash

# Wrapper for ssh-keygen to be used in git's gpg.ssh.program that allows
# specifying a different ssh agent and auto-adding a key to it

set -eu
shopt -s lastpipe

# shellcheck source-path=..
. "$HOME"/bin/.o 2>&1

function parse-opts {
	local arg
	while (( $# )); do
		arg="$1"; shift
		if [[ $arg == "-f" ]]; then
			key="$1"
		fi
		if [[ $arg == "-Y" ]]; then
			y_op="$1"
		fi
	done
}

key=
y_op=
parse-opts "$@"

if [[ $key && $y_op == sign ]]; then
	if git config --get gpg.ssh.agent-name | read -r agent_name; then
		export SSH_AUTH_SOCK="${XDG_RUNTIME_DIR}/ssh-agent-${agent_name}"
	fi
	o ssh-add "$key"
	o ssh-keygen "$@"
else
	exec ssh-keygen "$@"
fi
